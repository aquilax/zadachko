<!DOCTYPE html>
<head>
  <style>
    .main {
      display: flex;
      flex-direction: column;
    }
    #preview {
      margin-top: 1em;
      white-space: pre;
      max-width: 80ch;
      border: 1px solid #cecece;
    }
    @media print {
      section {
        display: none;
      }
      #preview {
        border: none;
        max-width: 100%;
      }
      div {
        break-inside: avoid;
      }
    }
  </style>
  <script
    id="MathJax-script"
    async
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"
  ></script>
</head>
<body>
  <div class="main">
    <section>
      <label>
        Задачи <br />
        <textarea id="template" rows="30" , cols="80">
Намерете числената стойност на израза:
$$ A = ( x - $1 )^2 , за x = $2 $$
---
$$ за x = $2 , A = ( $2  - $1 )^2 = 1 $$
---
1
---
2,3,1
1,2,1
2,3,1
3,4,1
4,5,1
5,6,1
6,7,1
===
            </textarea
        >
      </label>
      <br />
      <button id="generate-test">Генерирай тест</button>
      <button id="generate-all">Генерирай всичко</button>
      <button id="print" onclick="window.print();">Печат</button>
    </section>
    <div id="preview"></div>
  </div>
  <script>
    const generateTest = document.querySelector("#generate-test")
    const generateAll = document.querySelector("#generate-all")
    const template = document.querySelector("#template");
    const preview = document.querySelector("#preview");

    const TEST = 0;
    const ALL = 1;

    const process = (text, params) =>
      Object.keys(params).reduce((p, k) => {
        return p.replaceAll(k, params[k]);
      }, text);

    const formatParam = (p) => p.replaceAll(".", ",");

    const getParams = (text) =>
      text.split("\n").map((r) =>
        r.split(",").reduce((a, v, i) => {
          a[`$${i + 1}`] = formatParam(v);
          return a;
        }, {})
      );

    const getRandom = (items) =>
      items[Math.floor(Math.random() * items.length)];

    const getParts = (text) => {
      const a = text.split("---");
      if (a.length === 1) {
        return { problem: text, solution: "", answer: "", params: "" };
      }
      const params = a.slice(-1).pop();
      const [problem, solution, answer] = a.slice(0, -1);
      return {
        problem: (problem || "").trim(),
        solution: (solution || "").trim(),
        answer: (answer || "").trim(),
        params: params,
      };
    };

    const getGenerator = generatorType => e => {
      e.preventDefault();
      const text = template.value.trim();
      const tasks = text.split("===");
      preview.innerHTML = tasks
        .map((t) => {
          if (t.trim()) {
            const { problem, solution, answer, params } = getParts(t.trim());
            const par = getParams(params.trim());

            let bodyElements = [];
            if (generatorType === TEST) {
              bodyElements = [
              `Задача:
${problem}`,
              ];
            }
            if (generatorType === ALL) {
              bodyElements= [
              `Задача:
${problem}`,
              `Решение:
${solution}`,
              `Отговор: ${answer}`,
              ];
            }
            const body = bodyElements.filter((v) => v).join("\n");
            return par
              ? `<div class="task">${process(body, getRandom(par))}</div>`
              : tmpl;
          }
          return "";
        })
        .join("\n")
        .trim();
      window.MathJax.typeset();
    }
    generateTest.addEventListener("click", getGenerator(TEST));
    generateAll.addEventListener("click", getGenerator(ALL));
  </script>
</body>
